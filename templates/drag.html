{% extends "layout.html" %}
{% block content %}

<!-- Add jQuery and jQuery UI libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<div class="drag-container">
  <h1>{{ drag_data.title }}</h1>
  <p class="drag-instructions">{{ drag_data.description }}</p>
  
  <div class="drag-content">
    <!-- Draggable scenario images -->
    <div class="draggable-container">
      {% for scenario in drag_data.images %}
        <div id="{{ scenario.id }}" class="draggable scenario-image" data-is-offside="{{ scenario.is_offside|lower }}" data-feedback="{{ scenario.feedback }}">
          <img src="{{ url_for('static', filename=scenario.image) }}" alt="Football scenario {{ loop.index }}" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/soccer_ball.png') }}'; this.style.padding='20px'; this.parentNode.classList.add('image-error');">
        </div>
      {% endfor %}
    </div>
    
    <!-- Drop zones - now full-height and at edges -->
    <div class="dropzones">
      <div id="offside-zone" class="dropzone offside-zone">
        <h2>YES</h2>
        <div class="drop-area" data-answer="true">
          <div class="dropped-items"></div>
        </div>
      </div>
      
      <div id="not-offside-zone" class="dropzone not-offside-zone">
        <h2>NO</h2>
        <div class="drop-area" data-answer="false">
          <div class="dropped-items"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Feedback area -->
  <div class="feedback-container">
    <div id="feedback-area" class="feedback-area"></div>
    <div class="progress-container">
      <div class="progress-text">Progress: <span id="completed-count">0</span>/{{ drag_data.images|length }}</div>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
      </div>
    </div>
    <button id="continue-btn" class="big-arrow" style="display: none;" onclick="window.location.href='/quiz/0'">CONTINUE TO QUIZ</button>
  </div>
</div>

<style>

    .drag-container {
    max-width: 100%;
    margin: 40px 0 0 0;
    padding: 20px;
    position: relative;
    box-sizing: border-box;
  }
  
  .drag-instructions {
    font-size: 18px;
    margin-bottom: 30px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .drag-content {
    display: flex;
    flex-direction: column;
    min-height: 500px;
    position: relative;
  }
  
  .draggable-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    width: 100%;
    margin: 0 auto 30px auto;
    max-width: 800px;
    z-index: 2;
  }
  
  .scenario-image {
    width: 180px;
    height: 180px;
    border: 3px solid #fff;
    border-radius: 10px;
    overflow: hidden;
    cursor: move;
    transition: transform 0.2s, box-shadow 0.2s;
    background-color: #4a7a2d; /* Light green background */
    position: relative;
    z-index: 10;
  }
  
  .scenario-image:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 20;
  }
  
  .scenario-image img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Changed from cover to contain */
    display: block;
  }
  
  .dropzones {
    display: flex;
    justify-content: space-between;
    width: 100%;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1;
    pointer-events: none; /* So it doesn't block draggable items */
  }
  
  .dropzone {
    text-align: center;
    width: 30%;
    height: 100%;
    pointer-events: none; /* This ensures clicks go through to the drop-area */
    display: flex;
    flex-direction: column;
  }
  
  .offside-zone {
    margin-right: auto; /* Push to left edge */
  }
  
  .not-offside-zone {
    margin-left: auto; /* Push to right edge */
  }
  
  .drop-area {
    flex: 1;
    width: 100%;
    min-height: 500px;
    border: 3px dashed #e6ff57;
    border-radius: 20px;
    background: rgba(255,255,255,0.1);
    margin-top: 10px;
    transition: background 0.3s;
    pointer-events: auto; /* Make drop area clickable */
    padding: 10px;
    overflow-y: auto; /* Add scrolling if too many items */
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .drop-area .dropped-items {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
    width: 100%;
  }
  
  .drop-area.hover {
    background: rgba(230, 255, 87, 0.2);
  }
  
  .dropzone h2 {
    font-size: 60px;
    color: #e6ff57;
    margin: 10px 0;
    pointer-events: auto;
  }
  
  .feedback-container {
    margin-top: 40px;
    text-align: center;
  }
  
  .feedback-area {
    min-height: 80px;
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 500;
  }
  
  .progress-container {
    margin: 30px auto;
    max-width: 500px;
  }
  
  .progress-text {
    margin-bottom: 10px;
    font-size: 18px;
  }
  
  .progress-bar {
    height: 20px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: #e6ff57;
    width: 0%;
    transition: width 0.5s;
  }
  
  .correct {
    border-color: #4CAF50 !important;
  }
  
  .incorrect {
    border-color: #f44336 !important;
  }
</style>


<script>
  $(document).ready(function() {
    let completedCount = 0;
    const totalScenarios = {{ drag_data.images|length }};
    
    // Make scenario images draggable
    $(".draggable").draggable({
      revert: "invalid",
      zIndex: 100,
      start: function(event, ui) {
        $(this).addClass("dragging");
      },
      stop: function(event, ui) {
        $(this).removeClass("dragging");
      },
      // Center the item by its center, not top-left corner
      cursorAt: { top: 90, left: 90 }
    });
    
    // Make drop areas droppable
    $(".drop-area").droppable({
      accept: ".draggable",
      hoverClass: "hover",
      drop: function(event, ui) {
        const $draggable = $(ui.draggable);
        const isOffside = $draggable.data("is-offside") === "true";
        const dropZoneAnswer = $(this).data("answer") === true;
        const feedback = $draggable.data("feedback");
        
        // Find the dropped-items container within this drop area
        const $droppedItemsContainer = $(this).find(".dropped-items");
        
        // Position the draggable in the dropped-items container
        $draggable.detach().css({
          top: 0,
          left: 0,
          position: 'relative',
          margin: '5px auto',
          transform: 'none'
        }).appendTo($droppedItemsContainer);
        
        // Check if the answer is correct
        if ((isOffside && dropZoneAnswer) || (!isOffside && !dropZoneAnswer)) {
          $draggable.addClass("correct");
          $("#feedback-area").html(`<span style="color: #4CAF50;">Correct!</span> ${feedback}`);
        } else {
          $draggable.addClass("incorrect");
          $("#feedback-area").html(`<span style="color: #f44336;">Incorrect!</span> ${feedback}`);
        }
        
        // Disable dragging after drop
        $draggable.draggable("disable");
        
        // Update progress
        completedCount++;
        $("#completed-count").text(completedCount);
        const progressPercentage = (completedCount / totalScenarios) * 100;
        $("#progress-fill").css("width", `${progressPercentage}%`);
        
        // Send event to server
        sendEvent("drag_drop", {
          scenario_id: $draggable.attr("id"),
          is_correct: (isOffside && dropZoneAnswer) || (!isOffside && !dropZoneAnswer),
          user_answer: dropZoneAnswer ? "offside" : "not_offside",
          correct_answer: isOffside ? "offside" : "not_offside"
        });
        
        // Show continue button if all scenarios are completed
        if (completedCount === totalScenarios) {
          $("#continue-btn").fadeIn();
          sendEvent("drag_complete");
        }
      }
    });
    
    // Function to send event data to the server
    function sendEvent(type, data = {}) {
      fetch('/log_event', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          event_type: type,
          slide_number: null,
          timestamp: new Date().toISOString(),
          ...data
        })
      });
    }
    
    // Track when the page loads
    sendEvent("start_drag");
  });
</script>
