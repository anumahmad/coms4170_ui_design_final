{% extends "layout.html" %}
{% block content %}

<!-- Add jQuery and jQuery UI libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<div class="offsidedrag-container">
  <h1>{{ drag_data.title }}</h1>
  <p class="offsidedrag-instructions">{{ drag_data.description }}</p>
  
  <div class="offsidedrag-content">
    <!-- Draggable scenario images -->
    <div class="offsidedrag-videos-container">
      {% for scenario in drag_data.images %}
        <div id="{{ scenario.id }}" class="offsidedrag-draggable offsidedrag-video" data-is-offside="{{ 'true' if scenario.is_offside else 'false' }}" data-feedback="{{ scenario.feedback }}">
          <video width="100%" height="100%" preload="auto" muted autoplay loop playsinline>
            <source src="{{ url_for('static', filename=scenario.image) }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        </div>
      {% endfor %}
    </div>
    
    <!-- Drop zones -->
    <div class="offsidedrag-targets-container">
      <div id="offside-zone" class="offsidedrag-target offsidedrag-yes">
        <h2>YES</h2>
        <div class="offsidedrag-droparea" data-answer="true"></div>
      </div>
      
      <div id="not-offside-zone" class="offsidedrag-target offsidedrag-no">
        <h2>NO</h2>
        <div class="offsidedrag-droparea" data-answer="false"></div>
      </div>
    </div>
  </div>
  
  <!-- Feedback area -->
  <div class="offsidedrag-feedback-container">
    <div id="feedback-area" class="offsidedrag-feedback-text"></div>
    <div class="offsidedrag-progress-container">
      <div class="offsidedrag-progress-text">Progress: <span id="completed-count">0</span>/{{ drag_data.images|length }}</div>
      <div class="offsidedrag-progress-bar">
        <div id="progress-fill" class="offsidedrag-progress-fill" style="width: 0%"></div>
      </div>
    </div>
    <button id="continue-btn" class="big-arrow" style="display: none;" onclick="window.location.href='/quiz/0'">CONTINUE TO QUIZ</button>
  </div>
</div>

<style>
  /* Use namespaced classes to avoid conflicts with global CSS */
  .offsidedrag-container {
    width: 100%;
    max-width: 1200px;
    margin: 60px auto 30px auto;
    padding: 20px;
    box-sizing: border-box;
  }
  
  .offsidedrag-instructions {
    font-size: 18px;
    margin-bottom: 30px;
    text-align: center;
  }
  
  .offsidedrag-content {
    position: relative;
    display: flex;
    flex-direction: column;
    margin-bottom: 40px;
  }
  
  /* Videos container */
  .offsidedrag-videos-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    width: 100%;
    margin-bottom: 120px; /* Plenty of space below videos */
  }
  
  /* Video items */
  .offsidedrag-video {
    width: 280px;
    height: 160px;
    border: 3px solid #fff;
    border-radius: 10px;
    overflow: hidden;
    cursor: move;
    transition: transform 0.2s, box-shadow 0.2s;
    background-color: #1e3d0e;
    z-index: 50; /* Higher z-index to stay above other elements */
    position: relative;
  }
  
  .offsidedrag-video:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 60;
  }
  
  .offsidedrag-video video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  /* YES/NO targets container */
  .offsidedrag-targets-container {
    display: flex;
    justify-content: center;
    width: 100%;
    gap: 60px;
  }
  
  /* Individual YES/NO target */
  .offsidedrag-target {
    text-align: center;
    width: 40%;
    max-width: 400px;
  }
  
  /* Drop area */
  .offsidedrag-droparea {
    width: 100%;
    height: 250px;
    border: 3px solid #e6ff57;
    border-radius: 20px;
    background: rgba(255,255,255,0.1);
    margin: 10px auto;
    padding: 10px;
    position: relative;
  }
  
  /* Dropped video styles */
  .offsidedrag-droparea .offsidedrag-video {
    position: absolute;
    width: 200px;
    height: 120px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    margin: 0;
  }
  
  .offsidedrag-droparea.hover {
    background: rgba(230, 255, 87, 0.2);
  }
  
  .offsidedrag-target h2 {
    font-size: 60px;
    color: #e6ff57;
    margin: 0 0 10px 0;
  }
  
  /* Feedback section */
  .offsidedrag-feedback-container {
    margin-top: 40px;
    text-align: center;
    padding-bottom: 30px;
  }
  
  .offsidedrag-feedback-text {
    min-height: 80px;
    margin-bottom: 20px;
    font-size: 20px;
    font-weight: 500;
  }
  
  /* Progress display */
  .offsidedrag-progress-container {
    margin: 15px auto;
    max-width: 500px;
  }
  
  .offsidedrag-progress-text {
    margin-bottom: 10px;
    font-size: 18px;
  }
  
  .offsidedrag-progress-bar {
    height: 20px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    overflow: hidden;
  }
  
  .offsidedrag-progress-fill {
    height: 100%;
    background: #e6ff57;
    width: 0%;
    transition: width 0.5s;
  }
  
  /* Correct/incorrect indicators */
  .correct {
    border-color: #4CAF50 !important;
  }
  
  .incorrect {
    border-color: #f44336 !important;
  }
</style>

<script>
  $(document).ready(function() {
    let completedCount = 0;
    const totalScenarios = {{ drag_data.images|length }};
    
    // DEBUG: Log all draggable elements with their offside values
    $(".offsidedrag-draggable").each(function() {
      console.log(
        "Scenario", $(this).attr("id"), 
        "data-is-offside =", $(this).data("is-offside"),
        "type =", typeof $(this).data("is-offside")
      );
    });
    
    // Make videos draggable
    $(".offsidedrag-draggable").draggable({
      revert: "invalid",
      zIndex: 100,
      start: function(event, ui) {
        $(this).addClass("dragging");
      },
      stop: function(event, ui) {
        $(this).removeClass("dragging");
      }
    });
    
    // Make drop areas droppable
    $(".offsidedrag-droparea").droppable({
      accept: ".offsidedrag-draggable",
      hoverClass: "hover",
      drop: function(event, ui) {
        const $draggable = $(ui.draggable);
        const isOffside = $draggable.data("is-offside") === true || $draggable.data("is-offside") === "true";
        const dropZoneAnswer = $(this).data("answer") === true;
        const feedback = $draggable.data("feedback");
        
        // Position the draggable with overlapping effect in the drop area
        const $dropArea = $(this);
        const existingItems = $dropArea.children('.offsidedrag-video').length;
        const dropAreaWidth = $dropArea.width();
        const dropAreaHeight = $dropArea.height();
        
        // Detach and add to drop area
        $draggable.detach().appendTo($dropArea);
        
        // Calculate position with slight randomness for natural look
        const randomLeftOffset = Math.random() * 100 - 50; // -50 to +50px
        const randomTopOffset = Math.random() * 80 - 40;   // -40 to +40px
        const randomRotation = Math.random() * 16 - 8;     // -8 to +8 degrees
        
        // Position in the center with offsets
        $draggable.css({
          position: 'absolute',
          left: (dropAreaWidth / 2) - 100 + randomLeftOffset + 'px',
          top: (dropAreaHeight / 2) - 60 + randomTopOffset + 'px',
          margin: 0,
          transform: `rotate(${randomRotation}deg)`,
          transition: 'all 0.3s ease',
          zIndex: 10 + existingItems
        });
        
        // Make sure videos keep playing after being dropped
        $draggable.find('video').each(function() {
          // Restart the video to ensure it's playing
          this.currentTime = 0;
          this.play().catch(e => {
            console.log("Autoplay prevented:", e);
            // Some browsers block autoplay, this is a fallback
          });
        });
        
        // Check if the answer is correct - being very explicit
        const isCorrect = (isOffside === true && dropZoneAnswer === true) || 
                         (isOffside === false && dropZoneAnswer === false);
        
        // DEBUG: Log values to console
        console.log("Drop event:", {
          id: $draggable.attr("id"),
          isOffside: isOffside,
          typeOfIsOffside: typeof isOffside,
          dropZoneAnswer: dropZoneAnswer,
          typeOfDropZoneAnswer: typeof dropZoneAnswer,
          isCorrect: isCorrect
        });
        
        if (isCorrect) {
          $draggable.addClass("correct");
          $("#feedback-area").html(`<span style="color: #4CAF50;">Correct!</span> ${feedback}`);
        } else {
          $draggable.addClass("incorrect");
          $("#feedback-area").html(`<span style="color: #f44336;">Incorrect!</span> ${feedback}`);
        } 
        
        // Disable dragging after drop
        $draggable.draggable("disable");
        
        // Update progress
        completedCount++;
        $("#completed-count").text(completedCount);
        const progressPercentage = (completedCount / totalScenarios) * 100;
        $("#progress-fill").css("width", `${progressPercentage}%`);
        
        // Send event to server
        sendEvent("drag_drop", {
          scenario_id: $draggable.attr("id"),
          is_correct: (isOffside && dropZoneAnswer) || (!isOffside && !dropZoneAnswer),
          user_answer: dropZoneAnswer ? "offside" : "not_offside",
          correct_answer: isOffside ? "offside" : "not_offside"
        });
        
        // Show continue button if all scenarios are completed
        if (completedCount === totalScenarios) {
          $("#continue-btn").fadeIn();
          sendEvent("drag_complete");
        }
      }
    });
    
    // Function to send event data to the server
    function sendEvent(type, data = {}) {
      fetch('/log_event', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          event_type: type,
          slide_number: null,
          timestamp: new Date().toISOString(),
          ...data
        })
      });
    }
    
    // Track when the page loads
    sendEvent("start_drag");
  });
</script>
{% endblock %}
